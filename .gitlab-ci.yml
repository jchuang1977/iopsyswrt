stages:
  - sdk
  - build_nightlies

sdk:
  stage: sdk
  tags:
    - docker
  image:
    name: gcr.io/kaniko-project/executor:debug-v1.0.0
    entrypoint: [""]
  variables:
    GIT_DEPTH: 1
  script:
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"${REGISTRY_URL}\":{\"auth\":\"${REGISTRY_AUTH}\"}}}" > /kaniko/.docker/config.json
    - DOCKER_BASE_VERSION="$(grep -m1 '^FROM' Dockerfile | cut -d':' -f2)"
    - |
        /kaniko/executor \
          --context ${CI_PROJECT_DIR} \
          --dockerfile ${CI_PROJECT_DIR}/Dockerfile \
          --destination ${REGISTRY_REPOSITORY}:${CI_COMMIT_SHORT_SHA} \
          --destination ${REGISTRY_REPOSITORY}:${DOCKER_BASE_VERSION} \
          --destination ${REGISTRY_REPOSITORY}:latest
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - if: '$CI_COMMIT_BRANCH == "devel"'
      changes:
        - Dockerfile
        - docker/**
        - iop
  interruptible: true

.build_board_nightly:
  stage: build_nightlies
  tags:
    - docker
  image:
    name: ${REGISTRY_REPOSITORY}
  cache:
    key: IOPSYSWRT-nightly-$CI_JOB_NAME
    paths:
      - ./* # IOPSYSWRT whole directory
    policy: push
  script:
    - echo "https://gitlab-ci-token:${CI_JOB_TOKEN}@${CI_SERVER_HOST}" > ~/.git-credentials
    - ./iop bootstrap
    - ./iop feeds_update
    - ./iop genconfig_min $CI_JOB_NAME # Board is the same as job name
    - make -j$(nproc) || make -j1 V=s
  artifacts:
    paths:
      - bin/targets/*/*/*.y3
      - bin/targets/*/*/*.pkgtb
    expire_in: 2 week
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
  interruptible: true

dg400prime:
  extends: .build_board_nightly

ex400:
  extends: .build_board_nightly

smarthub3:
  extends: .build_board_nightly

disc:
  extends: .build_board_nightly
