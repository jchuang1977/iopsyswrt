variables:
  SKIP_TEST:
    value: "false"

stages:
  - Update docker image
  - IOPSYSWRT

.nightly:
  stage: IOPSYSWRT
  variables:
    BOARD_NAME: $CI_JOB_NAME
    BUILD_TYPE: $BUILD_TYPE
    SKIP_TEST: $SKIP_TEST
  trigger:
    project: devops/iopsyswrt
    strategy: depend
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'

.continuous:
  stage: IOPSYSWRT
  trigger:
    project: devops/iopsyswrt
    strategy: depend
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "devel"'
      changes:
        - feeds.conf

Update Docker Image:
  stage: Update docker image
  tags:
    - docker
  image:
    name: gcr.io/kaniko-project/executor:v1.5.2-debug
    entrypoint: [""]
  variables:
    GIT_DEPTH: 1
  script:
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"${REGISTRY_URL}\":{\"auth\":\"${REGISTRY_AUTH}\"}}}" > /kaniko/.docker/config.json
    - DOCKER_BASE_VERSION="$(grep -m1 '^FROM' Dockerfile | cut -d':' -f2)"
    - |
        /kaniko/executor \
          --context ${CI_PROJECT_DIR} \
          --dockerfile ${CI_PROJECT_DIR}/Dockerfile \
          --destination ${REGISTRY_REPOSITORY}:latest
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - if: '$CI_COMMIT_BRANCH == "$CI_DEFAULT_BRANCH" || $CI_COMMIT_BRANCH =~ /^release-\d+\.\d+$/'
      changes:
        - Dockerfile
        - docker/**
        - iop
  interruptible: true

# Continuous Build
SMARTHUB3_continuous:
  extends: .continuous
  variables:
    BOARD_NAME: "SMARTHUB3"

# Nightly
EX400:
  extends: .nightly
  variables:
    SKIP_TEST: "true"

SMARTHUB3:
  extends: .nightly
  variables:
    CUSTOMER_PROFILE: "EVAL"
    CUSTOMER_PROFILE_EXTRA: "ANALYTICS"

DISC:
  extends: .nightly
  variables:
    CUSTOMER_PROFILE: "EVAL"
    CUSTOMER_PROFILE_EXTRA: "ANALYTICS"
    SKIP_TEST: "true"

EAGLE:
  extends: .nightly
  variables:
    CUSTOMER_PROFILE: "EVAL"
    CUSTOMER_PROFILE_EXTRA: "ANALYTICS"

PANTHER:
  extends: .nightly

PANDA:
  extends: .nightly

KOALA:
  extends: .nightly
  variables:
    SKIP_TEST: "true"

EN7562:
  extends: .nightly
  variables:
    CUSTOMER_PROFILE: "EVAL"
    CUSTOMER_PROFILE_EXTRA: "ANALYTICS"

TIGER:
  extends: .nightly
  variables:
    SKIP_TEST: "true"

NVG578:
  extends: .nightly
  variables:
    CUSTOMER_PROFILE: "EVAL"
    SKIP_TEST: "true"
